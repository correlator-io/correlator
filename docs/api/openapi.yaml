openapi: 3.0.3
info:
  title: Correlator API
  version: 0.1.0
  description: |
    **Correlator Incident Correlation Engine API**

    Correlator automatically connects test failures to job runs and downstream impact
    across your data stack (dbt, Airflow, Great Expectations).

    ## Authentication

    Protected endpoints require API key authentication via `X-Api-Key` header.
    Public health endpoints (`/ping`, `/ready`, `/health`) do not require authentication.

    ## Base URLs

    - API endpoints: `/api/v1/*`
    - Health probes: `/ping`, `/ready`, `/health`

servers:
  - url: http://localhost:8080
    description: Local development server

security:
  - ApiKeyAuth: []

tags:
  - name: Health Probes
    description: Kubernetes liveness/readiness probes (public, no auth required)
  - name: OpenLineage Ingestion
    description: Plugin integration endpoint for OpenLineage event ingestion
  - name: Correlation Queries
    description: Incident list and detail endpoints for UI
  - name: Correlation Health
    description: Correlation system health and orphan dataset detection

paths:
  # Public Health Probes (no /api/v1 prefix, no auth)
  /ping:
    get:
      summary: Liveness probe
      description: |
        Kubernetes liveness probe. Returns "pong" if the server is running.
        No authentication required.
      operationId: ping
      tags:
        - Health Probes
      security: []
      responses:
        '200':
          description: Server is alive
          content:
            text/plain:
              schema:
                type: string
                example: pong

  /ready:
    get:
      summary: Readiness probe
      description: |
        Kubernetes readiness probe. Checks storage backend health.
        Returns 503 if storage is unavailable.
        No authentication required.
      operationId: ready
      tags:
        - Health Probes
      security: []
      responses:
        '200':
          description: Server is ready to accept traffic
          content:
            text/plain:
              schema:
                type: string
                example: ready
        '503':
          description: Storage backend unavailable
          content:
            text/plain:
              schema:
                type: string
                example: storage unavailable

  /health:
    get:
      summary: Health check
      description: |
        Basic health check endpoint returning service status, version, and uptime.
        No authentication required.
      operationId: health
      tags:
        - Health Probes
      security: []
      responses:
        '200':
          description: Health status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatus'
              example:
                status: healthy
                serviceName: correlator
                version: v1.0.0
                uptime: 2h30m15s

  # Protected API Endpoints (/api/v1/*)
  /api/v1/lineage/events:
    post:
      summary: Ingest OpenLineage events
      description: |
        Primary plugin integration endpoint. Accepts OpenLineage v1.0 compliant RunEvents
        from Correlator plugins (dbt-correlator, correlator-airflow, correlator-ge).

        Events are processed with idempotency - duplicate events are detected and counted
        as successful (OpenLineage specification behavior).

        **Request Limits:**
        - Max batch size: 1000 events
        - Max request body: 1 MB
      operationId: ingestLineageEvents
      tags:
        - OpenLineage Ingestion
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/LineageEvent'
              minItems: 1
              maxItems: 1000
            example:
              - eventTime: "2024-01-01T12:00:00Z"
                producer: "https://github.com/correlator-io/correlator-dbt/v1.0.0"
                schemaURL: "https://openlineage.io/spec/1-0-0/OpenLineage.json"
                eventType: "COMPLETE"
                run:
                  runId: "dbt:abc123-def456"
                job:
                  namespace: "dbt_prod"
                  name: "models.users"
                inputs:
                  - namespace: "postgresql://prod-db/public"
                    name: "raw_users"
                outputs:
                  - namespace: "postgresql://prod-db/public"
                    name: "clean_users"
      responses:
        '200':
          description: All events processed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LineageResponse'
        '207':
          description: Partial success - some events failed validation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LineageResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '413':
          $ref: '#/components/responses/PayloadTooLarge'
        '415':
          $ref: '#/components/responses/UnsupportedMediaType'
        '429':
          $ref: '#/components/responses/RateLimited'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/incidents:
    get:
      summary: List incidents
      description: |
        Retrieve paginated list of incidents. Supports filtering by time range.

        The view only returns failed/error test results that have lineage correlation.
      operationId: listIncidents
      tags:
        - Correlation Queries
      parameters:
        - name: since
          in: query
          description: Filter incidents after this timestamp (ISO8601)
          schema:
            type: string
            format: date-time
          example: "2024-01-01T00:00:00Z"
        - name: limit
          in: query
          description: Maximum number of incidents to return
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: offset
          in: query
          description: Number of incidents to skip for pagination
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: Paginated list of incidents
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IncidentListResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/incidents/{id}:
    get:
      summary: Get incident details
      description: |
        Retrieve detailed incident information including test details, dataset info,
        producing job, and downstream impact.

        The `correlation_status` field indicates:
        - `correlated`: Fully correlated with a data-producing job
        - `orphan`: Namespace aliasing issue (needs configuration)
        - `unknown`: Correlation status cannot be determined
      operationId: getIncidentDetails
      tags:
        - Correlation Queries
      parameters:
        - name: id
          in: path
          required: true
          description: Test result ID (numeric)
          schema:
            type: string
          example: "123"
      responses:
        '200':
          description: Incident details with downstream impact
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IncidentDetailResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/health/correlation:
    get:
      summary: Get correlation health
      description: |
        Returns correlation system health metrics including:
        - Correlation rate (correlated incidents / total incidents)
        - Dataset counts (total, produced, correlated)
        - Orphan datasets that need pattern configuration
        - Suggested patterns to resolve orphan datasets

        An Orphan dataset is a dataset that has test results (from validators like GE, dbt tests, Soda)
        but cannot be matched to any dataset that was produced by a data producer (like dbt models, Airflow tasks, Spark jobs).

        A produced dataset is a dataset that appears as an output of at least one job.

        A correlated dataset is a produced dataset that has test results linked to it.

        The suggested_patterns field provides auto-generated pattern configurations
        that can be added to .correlator.yaml to resolve orphan datasets.
      operationId: getCorrelationHealth
      tags:
        - Correlation Health
      responses:
        '200':
          description: Correlation health metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CorrelationHealthResponse'
              example:
                correlation_rate: 0.85
                total_datasets: 12
                produced_datasets: 8
                correlated_datasets: 6
                orphan_datasets:
                  - dataset_urn: "demo_postgres/customers"
                    test_count: 5
                    last_seen: "2026-02-10T15:00:00Z"
                    likely_match:
                      dataset_urn: "postgresql://demo/marts.customers"
                      confidence: 1.0
                      match_reason: "exact_table_name"
                suggested_patterns:
                  - pattern: "demo_postgres/{name}"
                    canonical: "postgresql://demo/marts.{name}"
                    resolves_count: 3
                    orphans_resolved:
                      - "demo_postgres/customers"
                      - "demo_postgres/orders"
                      - "demo_postgres/products"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-Api-Key
      description: API key for plugin authentication

  schemas:
    # Health Check Schemas
    HealthStatus:
      type: object
      required:
        - status
        - serviceName
        - version
      properties:
        status:
          type: string
          description: Service health status
          example: healthy
        serviceName:
          type: string
          description: Service name
          example: correlator
        version:
          type: string
          description: Service version
          example: v1.0.0
        uptime:
          type: string
          description: Service uptime duration
          example: 2h30m15s

    # OpenLineage Event Schemas
    LineageEvent:
      type: object
      required:
        - eventTime
        - eventType
        - run
        - job
      properties:
        eventTime:
          type: string
          format: date-time
          description: Event timestamp (ISO8601)
        eventType:
          type: string
          enum: [START, RUNNING, COMPLETE, ABORT, FAIL, OTHER]
          description: Event type
        producer:
          type: string
          description: Producer URL identifying the emitting system
        schemaURL:
          type: string
          description: OpenLineage schema URL
        run:
          $ref: '#/components/schemas/Run'
        job:
          $ref: '#/components/schemas/Job'
        inputs:
          type: array
          items:
            $ref: '#/components/schemas/Dataset'
        outputs:
          type: array
          items:
            $ref: '#/components/schemas/Dataset'

    Run:
      type: object
      required:
        - runId
      properties:
        runId:
          type: string
          description: Unique run identifier
        facets:
          type: object
          additionalProperties: true
          description: Run facets (OpenLineage spec)

    Job:
      type: object
      required:
        - namespace
        - name
      properties:
        namespace:
          type: string
          description: Job namespace
        name:
          type: string
          description: Job name
        facets:
          type: object
          additionalProperties: true
          description: Job facets (OpenLineage spec)

    Dataset:
      type: object
      required:
        - namespace
        - name
      properties:
        namespace:
          type: string
          description: Dataset namespace (e.g., postgresql://prod-db/public)
        name:
          type: string
          description: Dataset name (e.g., users)
        facets:
          type: object
          additionalProperties: true
        inputFacets:
          type: object
          additionalProperties: true
        outputFacets:
          type: object
          additionalProperties: true

    LineageResponse:
      type: object
      required:
        - status
        - summary
        - failed_events
        - correlation_id
        - timestamp
      properties:
        status:
          type: string
          enum: [success, error]
          description: Overall request status
        summary:
          $ref: '#/components/schemas/ResponseSummary'
        failed_events:
          type: array
          items:
            $ref: '#/components/schemas/FailedEvent'
        correlation_id:
          type: string
          description: Request correlation ID for tracing
        timestamp:
          type: string
          format: date-time
          description: Response timestamp

    ResponseSummary:
      type: object
      required:
        - received
        - successful
        - failed
        - retriable
        - non_retriable
      properties:
        received:
          type: integer
          description: Total events received
        successful:
          type: integer
          description: Successfully processed events
        failed:
          type: integer
          description: Failed events
        retriable:
          type: integer
          description: Retriable failures
        non_retriable:
          type: integer
          description: Non-retriable failures (validation errors)

    FailedEvent:
      type: object
      required:
        - index
        - reason
        - retriable
      properties:
        index:
          type: integer
          description: Zero-based index of failed event
        reason:
          type: string
          description: Failure reason
        retriable:
          type: boolean
          description: Whether failure is retriable

    # Incident Schemas
    IncidentListResponse:
      type: object
      required:
        - incidents
        - total
        - limit
        - offset
        - orphan_count
      properties:
        incidents:
          type: array
          items:
            $ref: '#/components/schemas/IncidentSummary'
        total:
          type: integer
          description: Total number of incidents matching filter
        limit:
          type: integer
          description: Page size
        offset:
          type: integer
          description: Page offset
        orphan_count:
          type: integer
          description: Number of datasets with test failures but no producer correlation (not shown in incidents list)

    IncidentSummary:
      type: object
      required:
        - id
        - test_name
        - test_type
        - test_status
        - dataset_urn
        - dataset_name
        - producer
        - job_name
        - job_run_id
        - downstream_count
        - has_correlation_issue
        - executed_at
      properties:
        id:
          type: string
          description: Test result ID
        test_name:
          type: string
          description: Test name
        test_type:
          type: string
          description: Test type (e.g., not_null, unique)
        test_status:
          type: string
          description: Test status (failed, error)
        dataset_urn:
          type: string
          description: Dataset URN
        dataset_name:
          type: string
          description: Dataset name
        producer:
          type: string
          description: Producing tool (e.g., dbt, great_expectations)
        job_name:
          type: string
          description: Job name
        job_run_id:
          type: string
          description: Job run ID
        downstream_count:
          type: integer
          description: Number of downstream datasets affected
        has_correlation_issue:
          type: boolean
          description: True if incident is in orphan namespace
        executed_at:
          type: string
          format: date-time
          description: Test execution timestamp

    IncidentDetailResponse:
      type: object
      required:
        - id
        - test
        - dataset
        - upstream
        - downstream
        - correlation_status
      properties:
        id:
          type: string
          description: Test result ID
        test:
          $ref: '#/components/schemas/TestDetail'
        dataset:
          $ref: '#/components/schemas/DatasetDetail'
        job:
          $ref: '#/components/schemas/JobDetail'
          nullable: true
          description: Null if uncorrelated
        upstream:
          type: array
          description: Datasets consumed to produce the tested dataset (data provenance)
          items:
            $ref: '#/components/schemas/UpstreamDataset'
        downstream:
          type: array
          description: Datasets affected by this dataset (impact analysis)
          items:
            $ref: '#/components/schemas/DownstreamDataset'
        correlation_status:
          type: string
          enum: [correlated, orphan, unknown]
          description: |
            - correlated: Fully correlated with data-producing job
            - orphan: Namespace aliasing issue
            - unknown: Cannot determine correlation

    TestDetail:
      type: object
      required:
        - name
        - type
        - status
        - message
        - executed_at
        - duration_ms
        - producer
      properties:
        name:
          type: string
        type:
          type: string
        status:
          type: string
        message:
          type: string
        executed_at:
          type: string
          format: date-time
        duration_ms:
          type: integer
          format: int64
        producer:
          type: string
          description: Tool that ran this test (e.g., "correlator-ge", "correlator-dbt")

    DatasetDetail:
      type: object
      required:
        - urn
        - name
        - namespace
      properties:
        urn:
          type: string
        name:
          type: string
        namespace:
          type: string

    JobDetail:
      type: object
      required:
        - name
        - namespace
        - run_id
        - producer
        - status
        - started_at
      properties:
        name:
          type: string
        namespace:
          type: string
        run_id:
          type: string
        producer:
          type: string
        status:
          type: string
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
          nullable: true

    DownstreamDataset:
      type: object
      required:
        - urn
        - name
        - depth
        - parentUrn
        - producer
      properties:
        urn:
          type: string
        name:
          type: string
        depth:
          type: integer
          description: Hops downstream from original dataset
        parentUrn:
          type: string
          description: Parent dataset URN for tree visualization
        producer:
          type: string
          description: Tool that produced this dataset (e.g., "dbt", "airflow")

    UpstreamDataset:
      type: object
      description: An upstream dataset in the data lineage tree (data provenance)
      required:
        - urn
        - name
        - depth
        - childUrn
        - producer
      properties:
        urn:
          type: string
          description: Dataset URN
        name:
          type: string
          description: Human-readable dataset name
        depth:
          type: integer
          description: Hops upstream from the tested dataset (1 = direct input)
        childUrn:
          type: string
          description: Child dataset URN - the dataset this upstream feeds into
        producer:
          type: string
          description: Tool that produced this upstream dataset (e.g., "dbt", "airflow")

    # Correlation Health Schemas
    CorrelationHealthResponse:
      type: object
      required:
        - correlation_rate
        - total_datasets
        - produced_datasets
        - correlated_datasets
        - orphan_datasets
        - suggested_patterns
      properties:
        correlation_rate:
          type: number
          format: float
          minimum: 0
          maximum: 1
          description: Ratio of correlated tested datasets to total tested datasets with failed tests (1.0 = all failed test datasets can be traced to a producer)
        total_datasets:
          type: integer
          description: Distinct datasets with test results
        produced_datasets:
          type: integer
          description: Distinct datasets with producer output edges
        correlated_datasets:
          type: integer
          description: Distinct datasets that have both test results and producer output edges
        orphan_datasets:
          type: array
          items:
            $ref: '#/components/schemas/OrphanDataset'
          description: Datasets requiring pattern configuration
        suggested_patterns:
          type: array
          items:
            $ref: '#/components/schemas/SuggestedPattern'
          description: Auto-generated patterns to resolve orphan datasets

    OrphanDataset:
      type: object
      required:
        - dataset_urn
        - test_count
        - last_seen
      properties:
        dataset_urn:
          type: string
          description: Orphan dataset URN (e.g., "demo_postgres/customers")
        test_count:
          type: integer
          description: Number of test results for this dataset
        last_seen:
          type: string
          format: date-time
          description: Most recent test execution timestamp
        likely_match:
          $ref: '#/components/schemas/DatasetMatch'
          nullable: true
          description: Candidate producer dataset match (null if no match found)

    DatasetMatch:
      type: object
      required:
        - dataset_urn
        - confidence
        - match_reason
      properties:
        dataset_urn:
          type: string
          description: Producer dataset URN that potentially matches the orphan
        confidence:
          type: number
          format: float
          minimum: 0
          maximum: 1
          description: Match confidence score (1.0 = exact table name match)
        match_reason:
          type: string
          description: |
            Explanation of why this match was suggested:
            - "exact_table_name": Table names extracted from both URNs are identical

    SuggestedPattern:
      type: object
      required:
        - pattern
        - canonical
        - resolves_count
        - orphans_resolved
      properties:
        pattern:
          type: string
          description: Source pattern to match orphan dataset URNs (e.g., "demo_postgres/{name}")
        canonical:
          type: string
          description: Target pattern to transform to canonical form (e.g., "postgresql://demo/marts.{name}")
        resolves_count:
          type: integer
          description: Number of orphan datasets this pattern would resolve
        orphans_resolved:
          type: array
          items:
            type: string
          description: List of orphan dataset URNs this pattern would resolve

    # Error Schema
    Error:
      type: object
      required:
        - type
        - title
        - status
      properties:
        type:
          type: string
          format: uri
          description: Problem type URI
        title:
          type: string
          description: Short human-readable summary
        status:
          type: integer
          description: HTTP status code
        detail:
          type: string
          description: Detailed explanation
        instance:
          type: string
          description: URI of the specific occurrence
        correlation_id:
          type: string
          description: Request correlation ID

  responses:
    BadRequest:
      description: Bad request - invalid input
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            type: "https://getcorrelator.io/problems/400"
            title: "Bad Request"
            status: 400
            detail: "Invalid parameter 'limit': must be between 1 and 100"

    Unauthorized:
      description: Authentication required
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            type: "https://getcorrelator.io/problems/401"
            title: "Unauthorized"
            status: 401
            detail: "Missing API key"

    NotFound:
      description: Resource not found
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            type: "https://getcorrelator.io/problems/404"
            title: "Not Found"
            status: 404
            detail: "Incident not found"

    PayloadTooLarge:
      description: Request body exceeds 1 MB limit
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            type: "https://getcorrelator.io/problems/413"
            title: "Payload Too Large"
            status: 413
            detail: "Request body exceeds maximum size of 1048576 bytes"

    UnsupportedMediaType:
      description: Content-Type must be application/json
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            type: "https://getcorrelator.io/problems/415"
            title: "Unsupported Media Type"
            status: 415
            detail: "Content-Type must be application/json"

    RateLimited:
      description: Rate limit exceeded
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            type: "https://getcorrelator.io/problems/429"
            title: "Rate Limited"
            status: 429
            detail: "Rate limit exceeded"

    InternalError:
      description: Internal server error
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            type: "https://getcorrelator.io/problems/500"
            title: "Internal Server Error"
            status: 500
            detail: "An unexpected error occurred"
